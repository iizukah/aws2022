---
marp: true
theme: gaia
headingDivider: 4
math: katex
paginate: true
---

# AWS認定データベース-専門知識

## 2章　リレーショナルデータベースサービス
### 2-1 Amazon Relational Database Service

#### 2-1-1 Amazon Relational Database Service(RDS)
* RDS:リレーショナルデータベースを提供するサービス。
* 選択可能なDBエンジン:MySQL, MariaDB, Oracle, SQL Server, PostgreSQL, Aurora
* 狭義にはAurora以外を指す(以下はAurora以外の話)。
* DBをEC2インスタンスに構築することもできるが、AWS管理範囲が多いため運用負荷が低い。
* RDSの場合、アプリケーション、SQLのDB最適化のみがユーザ管理範囲。

---

|責任|オンプレ|EC2|RDS|
|-|-|-|-|
|アプリ・SQL最適化|○|○|○|
|拡張性・可用性管理|○|○|×|
|DBバックアップ|○|○|×|
|DBエンジンパッチ|○|○|×|
|DBエンジンインストール|○|○|×|
|OSパッチ|○|○|×|
|OSインストール|○|×|×|
|サーバハードウェア|○|×|×|
|データセンター|○|×|×|

#### 2-1-2 RDSの可用性

* プライマリインスタンス:メインとなるDBインスタンス。
* スタンバイレプリカ:プライマリインスタントは異なるAZに配置されるインスタンス。マルチAZな高可用性を実現可能。
    * プライマリからスタンバイレプリカにデータ同期が行われる。
    * プライマリの障害発生時、スタンバイレプリカに自動フェイルオーバーする。
    * SQL Serverのみ、独自の機能であるDBのミラーリング(DBM)またはAlways On可用性グループ(AGs)を使用。

---

* スタンバイレプリカの目的は可用性向上であり、読み取り性能アップではない。後者の目的にはリードレプリカを使用する。
    * ただしAuroraの場合はスタンバイレプリカとリードレプリカ兼用。
* スタンバイレプリカが存在する際、RDS標準バックアップ(スナップショット取得)はスタンバイレプリカに対して実行される。
* データ同期の際にわずかにレイテンシーが増加する。性能安定化のために「プロビジョンドIOPS」ストレージ推奨。
* RDSの場合、シングルAZ配置またはマルチAZ配置を選択可能。途中で前者から後者に変更も可能。ただし本番稼働中の変更は非推奨。

---

* エンドポイント:DNS形式の接続情報。
    * 形式:DB名.ランダム文字列.リージョン名.rds.amazonaws.com
* DBインスタンスのIPアドレスに対してではなく、エンドポイントに対してクライアントからアクセスする。
    * プライマリの障害発生時、エンドポイントに紐づけられるアドレスが自動的にスタンバイレプリカに切り替えられる。
* フェイルオーバーは通常60～120秒で完了する。
    * DNSキャッシュが残る可能性を考慮して、キャッシュTTLを60秒以下に設定することが推奨(Auroraの場合は30秒以下)。
* 手動フェイルオーバーも可能。コンソール上で「フェイルオーバーして再起動」を選択する。

#### 2-1-3 RDSのパフォーマンス
* RDSインスタンスタイプ:インスタンスのスペック。
    * 命名規則:db.ファミリ/世代/追加機能.サイズ
    * 例:db.m6g.large
* インスタンスファミリ:汎用/メモリ最適化の2種類が存在する。
    * T:バースト可能。汎用。
    * M:バランス型。常時使用環境向け。汎用。
    * R:メモリ最適化。
    * X:大規模アプリ向け。メモリ最適化。
    * Z:コア周波数最大4.0GHz向け。メモリ最適化。

---
* インスタンス世代:数の大きい方が新しい世代。
* 追加機能の例
    * g:AWS Graviton2プロセッサ搭載。
    * e:Xeon E7-8880 v3(Haswell)プロセッサ搭載。
    * d:ローカルインスタンスストレージ追加。
* インスタンスサイズ:CPU、メモリ、EBS帯域幅、ネットワーク帯域、デフォルトの同時接続数(max_connections)など。

---

* ストレージタイプ

|タイプ|種別|性能|IOPS決定方法|
|-|-|-|-|
|汎用SSD|SSD|100-10,000IOPS|3IOPS/GB|
|プロビジョンドIOPS|SSD|1,000-30,000IOPS|設定値|
|マグネティック|HDD|100-数百IOPS|サイズ依存|

* Storage Auto Scaling:有効化時、ストレージ自動拡張。
    * 拡張条件:ストレージ空き容量が10%以下の状態が5分以上継続。
    * 拡張内容:5GBまたは割当容量12%のどちらか大きい方の容量。
    * ストレージ拡張後、次回変更まで最低6時間必要。

---

* リードレプリカ
    * 読込専用インスタンス。読込性能にかんしてパフォーマンス向上可能。
    * プライマリから非同期データコピー。
    * 1プライマリにつき最大5個作成可能。
    * プライマリとは異なるインスタンスタイプを選択可能。
    * 手動でプライマリに昇格可能。
    * プライマリと別AZまたはリージョンに作成可能(SQL Server以外)。
    * 自動バックアップ有効かつ保持期間0以外に設定する(リードレプリカ作成時にスナップショットを利用するため)。

---

* リードレプリカ(Cont.)
    * 作成直後はデータ差分の同期が発生し、パフォーマンス低下の可能性がある。
    * 接続エンドポイントはリードレプリカ毎に独立。複数レプリカに分散処理させたい場合はRoute53で各エンドポイント情報を一つのDNSエンドポイントに登録する必要がある。
        * Auroraの場合、読込エンドポイントがデフォルトで存在。

---

* SQL Serverのリードレプリカ
    * SQL Server Enterprise Edition(EE)エンジンでのみ使用可能。
    * マルチリージョン・マルチAZのリードレプリカ不可。
    * プライマリインスタンスは、AlwaysOn可用性グループをもつマルチAZ配置の必要がある。
* Oracleのリードレプリカ
    * Oracleの機能であるActive Data Guardを同期の仕組みとして使用。
    * 通常の読込専用レプリカと、マウントモードのレプリカが存在。後者は読み取り処理不可(クロスリージョンの災害対策目的)。
    * Oracle Enterprise Edition(EE)でのみ使用可能。

---

* Amazon RDS Proxy:コネクションプーリングの機能。
    * コネクションプーリング:DBへの接続手法。クライアントからのアクセスの都度接続・切断を繰り返すのではなく、一度作成した接続を維持する技術。新規接続の負荷を減らし、最大接続数エラーの発生を抑制する。
    * EC2インスタンスなどの場合、クライアント側でコネクションプーリング実装可能。
    * Lambdaの場合、関数実行の都度Lambda用コンテナが起動するので、RDS Proxyを使用する。
    * 書込(プライマリ)インスタンスのみ対応。

#### 2-1-4 RDSのセキュリティ

* アクセス制御:セキュリティグループ/ネットワークACLを使用。
    * RDSインスタンスはVPC上で起動する。
    * 最低2つのサブネットが必須。

---

* データ格納時の暗号化:KMSを使用。AWS側で透過的に暗号化されるので、クライアント側の設定は不要。
* 暗号化されるリソース
    * DBインスタンス内データ
    * 自動バックアップ
    * リードレプリカ
    * スナップショット
    * ログファイル

---

* データ暗号化の制約
    * 作成時のみ暗号化可能。既存インスタンスの暗号化は、スナップショットを作成し、スナップショットコピー時に暗号化し、リストア。
    * 暗号化有効/無効は、プライマリとリードレプリカで共通でなければならない。
    * リージョン間でスナップショットをコピーする際、コピー先リージョンで別途KMSキーの指定が必要。
* Oracle/SQL Serverの場合、TDE(Transparent Data Encryption)を使用した暗号化も可能。特に要件がない限り、RDSの暗号化有効のみでよい。

---

* データ伝送中の暗号化:SSL/TLSを使用する。
    1. ルート証明書をAWSサイトからダウンロード(必要に応じて中間証明書も)。
    2. DB接続を行うクライアント側でSSLオプションを有効化。ルート証明書を使用する。
    3. 必要に応じてユーザにSSL接続を強制。
* MySQLの接続例
> mysql -h myinstance.xxxx.rds-ap-northeast1-1.amazonaws.com --ssl-ca~[full path]rds-combined-ca-bundle.pem --ssl-mode=VERIFY_IDENTITY GRANT USAGE ON *.* TO 'encrypt_user'@'%'REQUIRE SSL;

---

* SSL/TLS証明書の更新:証明書は定期更新が必要。2020年1月14日以前のRDSにはrds-ca-2015証明書が使用されており、それ以降のRDSにはrds-ca-2019証明書が使用されている。
* IAMを使用したDBアクセス認証:通常の認証情報は、DBユーザ・パスワード。
    * MySQl、PostgreSQL、Aurora対応。
    * 各RDSの認証情報を一元管理可能。
    * パスワード漏洩リスクがない。

---

* IAM認証の設定方法
    1. RDS側で「IAM DB認証」有効化。
    2. Actionにrds-db:connect、ResourceにRDSARNを許可したIAMポリシーを作成し、IAMユーザ/グループにアタッチ。
    3. RDS側でIAM認証用ユーザ作成。たとえばMySQLの場合「AWSAuthenticationPlugin」を使用する。
    4. RDSの「generate-db-auth-token」を使用して認証トークンを発行(一時的認証情報)。
    5. 認証トークンをDB接続時のコマンドに設定。たとえばMySQLの場合、「--password」オプションに設定。

---

* 監査ログ:DBエンジンの監査ログ機能を使用可能。たとえばMySQL/MariaDBの場合、MariaDB Audit Pluginを使用する。ログはCloudWatchへ転送可能。
* テーブルレベルのアクセス制御:RDS機能でテーブルレベルのアクセス制御は不可。GRANT/REVOKEコマンドをユーザが実行。

#### 2-1-5 RDSのコスト

* RDSで発生するコスト:DBインスタンス、ストレージ、データ転送。

* DBインスタンス:1時間単位。1時間未満は10分最小料金で秒単位請求。
* インスタンスサイズ:サイズ一段階につき倍額。
* インスタンスファミリ:メモリ最適化の方がやや高額。
* マルチAZ構成・リードレプリカ:プライマリと同等料金が発生。
* DBエンジン:PostgreSQLがやや高。「ライセンス込み」エンジンが基本高い。「ライセンス持ち込み」はOracleのみ可能。

---

* リザーブドインスタンス1年または3年、前払い無し/一部前払い/全前払いから選択可能。
* 現時点でSavings PlansはRDS非対応。
* インスタンスの停止
    * 停止中はインスタンス料金未発生。
    * ただし1週間経過で自動起動。
    * ストレージ料金は停止中も発生。
    * リードレプリカが存在する場合、停止不可。削除のみ可能。

---

* ストレージ:以下はシングルAZ。マルチAZの場合、マグネティックのIO料金以外すべて倍。

|タイプ|1GB1か月あたり料金|I/O料金|
|-|-|-|
|汎用SSD|0.138USD|課金なし|
|プロビジョンドIOPS|0.15USD|0.12USD/IOPS|
|マグネティック|0.12USD|0.12USD/100万リクエスト|

---

* バックアップストレージ:普通のストレージ料金よりも安い。
* データ転送:データ転送受信(in)は無料。データ転送送信(out)はVPC内無料、VPC外0.084～0.114USD/GB。

#### 2-1-6 RDSのメンテナンス

* メンテナンスウィンドウ:OSやDBエンジン更新、パッチ適用などの更新作業時間帯。ユーザが設定し、AWSが実施する。DBインスタンスが一時的に利用不可となるため、DB使用率が最も低い時間帯を設定するべき。
* メンテナンスウィンドウは、ユーザ側で週次の時間帯を設定。未指定の場合、AWSがランダムに割り当てた30分間。ただし大規模なメンテンナンスは30分以上かかる。

---

* メンテナンスの状態
    * 必須:無期限延期不可。
    * 利用可能:手動適用可能。無期限延期可能。
    * 次のウィンドウ:次回実行予定。
    * 進行中:現在進行中。
* マルチAZ配置のメンテナンス手順(ただしDBエンジン更新は両方同時)
    1. スタンバイに対するメンテナンス実行。
    2. スタンバイをプライマリに昇格。
    3. 旧プライマリ=新スタンバイのメンテナンス実行。

---

* DBインスタンスの変更:ユーザの任意タイミングで実行可能。
* DBエンジンのバージョン更新
    * メジャーバージョン:ユーザ手動実施可能。即時または次のメンテナンスウィンドウを選択。
    : マイナーバージョン:手動も自動も可能。児童の場合、メンテナンスウィンドウで実施。
* DBパラメータグループ:DBエンジンの設定値。OSから直接設定は不可能。ログ設定、文字コードなど。
* オプショングループ:DBエンジンの追加設定。セキュリティ強化、プラグインなど。

---

* RDSのクォータ:デフォルト値以上の設定には、引き上げリクエストが必要。
* DBインスタンスのクォータは40個。
* 全DBインスタンスの合計ストレージのクォータは100TB。

#### 2-1-7 RDSのバックアップ

* スナップショット:RDSの標準バックアップ機能。
* 自動バックアップ
    * 有効化時、ユーザ指定日数分のスナップショットを自動保持。
    * 保持日数は0～35で指定。0の場合、自動バックアップ無効。デフォルト7。
    * 初回バックアップは全データ、2回目以降は差分のみ。
    * バックアップウィンドウ:バックアップを実行するユーザ指定時間帯。メンテナンスウィンドウと重複不可。

---

* 自動バックアップ(Cont.)
    * シングルAZの場合、バックアップ開始時に一時的にI/O中断の可能性がある。
    * マルチAZの場合、バックアップはスタンバイインスタンスから取得(SQL Server除く)。
    * スナップショットはAWS管理のS3に保存される(ユーザ側から直接確認はできない)。
* 手動スナップショット:任意タイミングでスナップショット取得。自動スナップショットは保持期間後自動削除されるが、手動の場合は自動削除されない。

---

* AWS Backup:EC2、DynamoDB、RDSなどのバックアップ処理を一元管理するサービス。
    * 他サービスと合わせて保持期間や取得時間帯を一括設定可能。
    * コピーも自動実行可能。
    * 保持日数指定ではなく時間単位でバックアップ実行。
* スナップショットのコピー
    * コピー時のスナップショットは手動として扱われる。
    * 他リージョンへのコピーの場合、KMSキー、パラメータグループ、オプショングループは別途作成が必要。

---

* スナップショットの共有:手動スナップショットは別AWSアカウントと共有可能。
    * 暗号化している場合、暗号化キーへのアクセス許可が必要。デフォルトKMSキー(AWS管理CMK)は共有不可。
* スナップショットの復元:スナップショットからDBインスタンスを新規作成可能。既存DBインスタンスへの復元は不可。
* ポイントインタイムリカバリ:日次取得されるスナップショットとは別に、トランザクションログがS3に5分単位で保存される。そのため保持期間内(最短5分前)の特定の時間の復元が可能。
* S3へのエクスポート機能:スナップショットからS3へエクスポート可能。その際Apache Parquetという圧縮形式で保存され、AthenaやRedshift Spectrumなどから検索可能。

#### 2-1-8 RDSのモニタリング

* CloudWatchによるモニタリング:以下のようなメトリクスをモニタリング可能。
    * CPUUtilization
    * DatabaseConnections
    * FreeableMemory
    * FreeStorageSpace
    * ReadIOPS
    * WriteIOPS

---

* CloudWatchアラーム(+SNS):メトリクス値に応じたメール通知などを設定可能。
* CloudWatch Logs:DBエンジンの出力ログを発行可能。
* RDSの拡張モニタリング:有効化時、詳細なデータをモニタリング可能。CloudWatch Logsにも出力される。
    * guest/idle/user単位のCPU使用率。
    * キャッシュ、バッファ、スワップなどを含むメモリ使用状況。
    * 物理デバイスごとのディスクI/O。
    * OSプロセスのリスト。

---

* パフォーマンスインサイト:RDSのパフォーマンスデータ集計・可視化機能。
* イベントサブスクリプション:再起動やバックアップなどのイベント発生時に、SNSトピックへ通知する機能。

#### 2-1-9 RDSのトラブルシューティング

* RDSに接続できない。
    * セキュリティグループの設定。
    * 接続コマンドのミス。
* マスターユーザーパスワードを忘れた。
    * マネジメントコンソールからリセット可能。
    * CLIでは「aws rds modify-db-instance」を使用可能。
* ストレージ残量が0になった。
    * 「aws modify-db-instance」コマンドまたはModifyDBInstance APIを使用してストレージを拡張する。

---

* DBインスタンスが作成できない。
    * AWS側のキャパシティ不足。しばらく待機するか、インスタンスタイプやAZを変更する。
* バックアップ保持期間を0に設定できない。
    * リードレプリカが存在する場合、不可能。
* 一時的なDBインスタンスの停止ができない。
    * リードレプリカが含まれている場合、停止不可能。


### 2-2 Amazon Aurora

#### 2-2-1 Amazon Aurora

* Amazon Aurora
    * AWSの構築したデータベース。MySQLおよびPostgreSQL互換。
    * AuroraのDBクラスター:複数のDBインスタンスとデータ管理クラスターボリュームから成る。
    * インスタンスとストレージが分離しているのが特徴(通常のRDSの場合、EBSがインスタンスにアタッチされていた)。
    * 読込処理と自動フェイルオーバー可能なリードレプリカを作成可能。

 ---

* Amazon Aurora(Cont.)
    * データボリュームは、3AZに2個ずつ合計6個のコピーが作成され、高い耐障害性をもつ。
        * 書込処理は並列で行われるため、このコピーによるレイテンシは発生しない。
    * クォーラム・モデル:書込は6個中4個、読込処理は6個中3個成功したらクライアント側に成功と返す。
    * MySQLの最大5倍、PostgreSQLの最大3倍高速とされる。

---

* Auroraのコンポーネント
    * プライマリDBインスタンス:読書可能なDBインスタンス。Writerとも呼ばれる。
    * Auroraレプリカ:読込専用インスタンス。最大15個作成可能。プライマリの障害時、プライマリに昇格。Readerとも呼ばれる。
    * クラスターボリューム:データが保存される仮想ボリューム。3AZに2個ずつレプリケートされる。プライマリもレプリカも共通のボリュームを利用する。
    * Aurora DBクラスター:Writer/Reader/ボリュームをまとめた総称。

---

* Auroraエンドポイント:Auroraに接続するためのURL。
    * クラスターエンドポイント:クライアントの接続先。
    * 読込エンドポイント:複数レプリカに分散アクセス。
    * カスタムエンドポイント:特定インスタンスを指定したURL。分析などの特定用途向け。
    * インスタンスエンドポイント:インスタンスに対するエンドポイント。フェイルオーバー時、書込み不可になる。

#### 2-2-2 Auroraの可用性

* クラスターボリュームの可用性
    * 合計6個のクラスターが存在する。
    * 6個中2つに障害(AZ障害)が発生しても影響はない。
    * 3つに障害が発生した場合、読込のみ可能。
* インスタンスの可用性
    * Auroraレプリカを作成することで、インスタンスのマルチAZ構成が可能。
    * AuroraレプリカはRDSのスタンバイインスタンスとリードレプリカ両方の役割をもつ。
    * クライアントからはクラスターエンドポイントに接続する。

---

* インスタンスの可用性(Cont.)
    * 複数レプリカが存在する場合、昇格するレプリカは「1. 指定優先度の高さ、2. サイズの大きさ、 3. 任意」という順で評価する。
    * フェイルオーバー時間はたいてい60秒未満(通常のRDSは60～120秒)。
* クラスターキャッシュ管理: Aurora PostgreSQLの機能。有効化時、レプリカにキャッシュ情報を同期し、パフォーマンス影響を少なくする。

---

* Auroraグローバルデータベース
    * 複数リージョンにまたがってAuroraを構築する機能。
    * クライアントはレイテンシ最短リージョンのDBに接続される。
    * リージョン間フェイルオーバーは通常60秒未満。災害復旧として役立つ。
    * リージョン間データコピーは自動実行。通常1秒未満。
    * 1つのプライマリリージョンと最大5つのセカンダリリージョンから成る。書き込みはプライマリのみ可能で、セカンダリは読込専用。

---

* クロスリージョンレプリケーション:他リージョンに読込専用Auroraクラスタを作成する機能。グローバルデータベースよりもデータコピーに時間がかかる。
* Auroraマルチマスタークラスター:クラスタ内全インスタンスを読書可能にする機能。インスタンス障害時も継続して書き込み処理が可能。フェイルオーバーという概念がない。
    * PostgreSQLは対象外。
    * インスタンス数は最大2つ。
    * インスタンス停止不可。
    * 通常よりも書込パフォーマンスが落ちることがある(性能向上ではなく可用性目的)。
    * バックトラック機能の利用不可。

#### 2-2-3 Auroraのパフォーマンス
* ストレージ:AWS管理。データ量に応じて自動増加(最大128TB;以前は64TB)。
* Auroraレプリカ:可用性・性能向上。最大15作成可能。
    * 読込エンドポイント:複数レプリカに分散アクセス。
* Amazon Aurora Auto Scaling:CPU/接続数をターゲット値として指定し、レプリカを自動増減させる機能。
* Amazon Aurora Serverless:DBインスタンスのサイズ指定不要で、CPUやメモリといったキャパシティを自動スケールする機能。
    * Auroraキャパシティユニット(ACU):Auroraのキャパシティ単位。ACUの増減によってServerlessの自動スケーリングを行う。

---

* Aurora Serverlessのユースケース
    * 利用頻度の少ないアプリ。
    * 利用頻度の増減が激しいアプリ。
    * 開発環境(夜間は利用しない)。
* Aurora Serverless V1
    * スケーリングがV2より遅い。
    * マルチAZ未対応。
    * グローバルデータベース未対応。
* Aurora Serverless V2(プレビュー):認定試験ではV1の可能性が高い。

---
* Aurora Serverlessの開発者向け機能。
    * Query Editor:マネジメントコンソールからSQL実行。
    * Data API:HTTPSのAPI形式でデータ取得(JSON)。
* Aurora Serverlessのクエリ並列化:ストレージが分散されているため、複数SQLクエリの並列実行の方がパフォーマンスが高いことが多い。

#### 2-2-4 Auroraのセキュリティ

* Advanced Auditing:Aurora独自の監査機能。

#### 2-2-5 Auroraのコスト

* Aurora Serverless:ACUあたりの料金設定。1ACUは約2GBメモリの性能をもち、東京リージョンで0.1USD/h。ACU数は自動設定のため、見積は難しい。
* Auroraのストレージ:容量自動割当のため、使用分にのみ発生。通常のRDSは作成時に確保した容量分の料金が発生する。
    * 2020年10月以後、データ削除時に課金対象も減少。

#### 2-2-6 Auroraのメンテナンス

* DBクラスターパラメータグループ:Aurora独自のグループ。クラスタ内全インスタンスで共通の設定を記述する。
* ダウンタイムのないパッチ適用(ZDP)機能:Aurora MySQLの機能。ベストエフォートで、パッチ適用中もクライアント接続を維持する。
* Auroraのクォータ:DBクラスター40個。

#### 2-2-7 Auroraのバックアップ

* バックアップ:データのバックアップは日次ではなく継続的かつ増分。保持期間は1～35日。0(無効)不可。デフォルト保持期間は1日。バックアップウィンドウは、データではなくシステムバックアップを日次で取得する。
* スナップショット:1日以上のバックアップを取得する際に使用。
* データの復元:バックアップ・スナップショットいずれもDBクラスター新規作成によって復元。バックアップデータから復旧する場合、ポイントインタイムを指定可能。通常は現在時間の5分以内を指定可能(通常のRDSよりも短い指定が可能)。

---

* Auroraクローン:データストレージのコピーはせず、インスタンス部分のコピーを行う。高速にコピークラスターを作成。
    * 書込みの多いユースケースには不向き(データ書き込み時、新しいストレージ割当が発生するため)。
    * ユースケース
        * データのエクスポートや分析など、読込操作を実行する場合。
        * 本番稼働のデータを開発やテスト用途で使用する場合。
* S3へのエクスポート機能
    * 「SELECT INTO OUTFILE S3」というクエリでエクスポート。
    * 「LOAD DATA FROM S3」というクエリでインポート。移行用途にも使用される。


---

* バックトラック:巻き戻し機能。
    * バックアップからの復旧と異なり、以下のことが可能。
        * 直前で実行したDELETE処理などの取り消し。
        * 直接操作前に戻して、また進めることで、その時間でどのようなデータ変更があったか調べる。
    * ターゲットバックトラックウィンドウ:最大巻き戻し時間。
    * 制限
        * 上限72時間。
        * クラスタ作成時またはスナップショット復元時に有効化可能。
        * バックトラック処理中はDBインスタンスがわずかに中断。
        * Aurora MySQLでのみ使用可能。


#### 2-2-8 Auroraのモニタリング

* Auroraのメトリクス:ストレージ使用量やIOPSはクラスターのメトリクス、CPU使用率やメモリ使用率はインスタンスのメトリクスとして収集される。
* 障害挿入クエリ:障害テストを可能にするクエリ
    * DBインスタンスの障害。
    * Auroraレプリカの障害。
    * ディスクの障害。
    * ディスクの輻輳。

---

* 障害クエリの例:DBインスタンスの障害

> ALTER SYSTEM CRASH [INSTANCE|DISPATCHER|NODE];

* データベースアクティビティストリーム:CloudWatch Logsよりもリアルタイムな監視機能。有効化時、AuroraクラスタのアクティビティがKinesis Data Streamsに連携される。


#### 2-2-9 Auroraのトラブルシューティング

* ローカルストレージ容量不足:セッションの一時テーブルなどは、インスタンスのストレージを使用。CloudWatchのFreeLocalStorageメトリクスで把握可能。

#### 2-2-10 Auroraのその他の機能

* Aurora MySQLからLambda関数の呼び出し:SQLクエリを使用してLambda関数を実行可能。前提としてAuroraクラスタに、Lambda実行許可のIAMロールが必要。
* 実行例
> SELECT lambda_sync('arn:aws:lambda:us-east-1:xxx:function:xxxLambda', '{"operation":"ping"}');
* Aurora MySQLから機械学習実行:SageMakerやComprehendを呼び出す。

### 2-3 Amazon Redshift

* Amazon Redshift:データ分析用のデータウェアハウスサービス。
    * S3やRDSのデータを取り込み、SQLクライアントやBIツールを使用してデータを活用する。
    * PostgreSQL用JDBCおよびODBC(Open Database Connectivity)ドライバを使用してSQL接続可能。
* Redshiftの構造
    * リーダーノード:SQL接続受理ノード。
    * コンピュートノード:ストレージおよびクエリ実行ノード。
    * クラスター:リーダーノードと複数コンピュートノードのグループ。

---

* 同時実行スケーリング:読込処理増加に応じてクラスタ容量を自動追加する機能。
* ノードタイプ
    * DC2ノード:ローカルSSDを使用。高パフォーマンス。
    * DS2ノード:HDDを使用。低コスト。
    * RA3:2019年12月に発表されたタイプ。キャッシュデータをコンピュートノードに持ち、実データをAWS管理S3バケットに保管する。
* シェアードナッシング:DC2/DS2のデータ構造。

---

* 列指向ストレージ:テーブルの列ごとにデータ格納する方式。データ分析の際に高パフォーマンス。
* Redshiftへのデータロード
    * 定期的なINSERT/UPDATEは推奨されない。
    * COPYコマンドによるS3バケットからの複数テキストデータ並列アップロードが推奨。
    * スライス(ノード内の単位)数の倍数でファイル数を分割してアップロードすると高速。
    * EMR、DynamoDB、EC2からのCOPYアップロードにも対応。

---

* Redshift Spectrum
    * S3のデータファイルを直接Redshiftから読込む機能。
    * ノード上にデータを格納するより読込パフォーマンスは落ちる。
    * 低コストなデータウェアハウスを実現可能。
    * 高頻度アクセスデータはRedshiftのノード上に、低頻度アクセスデータはS3バケットに格納する、など。
    * 対応フォーマット:Parquet、ORC、JSON、Grok、Avro、CSV。
    * RA3ノードのS3バケットはAWS管理だが、Spectrumの場合ユーザ管理バケットデータを読み取り可能。

### 2-4 リレーショナルデータベースまとめ

* リレーショナルデータベース
    * データをテーブル(2次元表形式)で格納。
    * データへはSQL文を使用してアクセス。
    * データアクセス時のレスポンスに強い一貫性をもつ。
    * 外部キーなどを使用してテーブル間でリレーションを構築。

---

|サービス|ユースケース|特徴|
|-|-|-|
|RDS|オンプレからの移行,ERP,CRM,eコマース|現行DBエンジンを使用可能|
|Aurora|オンプレからの移行,ERP,CRM,eコマース|MySQL/PostgreSQL互換のAWS独自RDBMS|
|Redshift|データウェアハウス|列指向RDB,集計特化|

---

* ACID:リレーショナルデータベースの特徴の一つ。トランザクション単位でACID特性をもつ。
    * 原子性:Atomicity。トランザクションは完全に実行されるか、全く実行されないかのどちらかである。
    * 一貫性:Consistency。決められたDBルール条件を満たす。
    * 独立性:Isolation。トランザクションを単独実行した場合でも、同時に複数実行した場合でも同じ結果である(トランザクション間で相互に影響は与えない)。
    * 耐久性:Durability。ハードウェアなどの障害があっても、完了したトランザクションの結果は失われない。

## 3章 NoSQLデータベースサービス
### 3-1 Amazon DynamoDB
#### 3-1-1 Amazon DynamoDB

* Amazon DynamoDB:フルマネージド型NoSQLサービス。
    * key-valueおよびドキュメントデータモデルをサポート。
    * 規模にかかわらず数ミリ秒台のパフォーマンスを発揮。
* パーティション:格納データを分散保持するためのAWS管理領域。
    * パーティションはSSDに割り当てられたデータ領域。容量不足などの際、自動追加。対象リージョンの複数AZに自動複製。
    * パーティションキーのハッシュ値をもとにデータを格納するパーティションを決定。データの格納先はパーティションキーによって決定され、ソートキー順に格納される。

---

* ゲームアプリの例:テーブルにゲームのハイスコア情報を格納。
    * テーブルのデータの一つ一つは「Item」と呼ばれる。
    * 一つのItemには、一意のユーザID、ハイスコア、最終更新日などの情報が含まれていると想定する(一つ一つのデータはAttributeと呼ばれる)。
* 一つのテーブルに単一のゲームタイトルのハイスコアを登録。
    * ユーザIDだけをプライマリキーとして設定する。この場合、ユーザIDがパーティションキーとなる。
* 一つのテーブルに複数のゲームタイトルのハイスコアを登録。
    * プライマリーキーはユーザIDと「ゲームタイトル」というAttributeから複合されると想定する。このときユーザIDはパーティションキー、ゲームタイトルはソートキーと呼ばれる。
    
---

* トランザクション:複数の読込/書込みをグループ化することで、オールオアナッシングの一連の処理として扱える。
    * 書込みの場合はTransactWriteItems操作、読込の場合はTransactGetItems操作を使用する。
* Amazon DynamoDB Accelerator(DAX):Itemの値やクエリ結果をキャッシュするインメモリキャッシュ。
    * 読込リクエストに対して高速レスポンスが可能。
    * 通常ミリ秒単位のレスポンス速度を、マイクロ秒単位まで短縮する。
    * DAXはVPC内クラスタとして動作し、ノードを増やすことでさらに性能向上を見込める。

---

* DynamoDBストリーム:テーブル内Itemレベルの変更を時系列でキャプチャする機能。最大24時間ログ保存。
    * DynamoDBストリームの出力内容:プライマリーキーのみ、変更後の内容、変更前の内容、または変更前・変更後両方の内容。
* Amazon DynamoDBグローバルテーブル:複数リージョンにまたがるDynamoDB。
    * 対象となる任意リージョンに一つずつレプリカテーブルを作成。
    * 書込みの際、互いに変更を伝播し合い、グローバルテーブル全体でのデータ整合性を保持。

---


* 現行バージョン(2019.11.21)のグローバルテーブル設計要件。
    * 全テーブル名が同じ。
    * 全書込みキャパシティ管理設定が同じ。
    * 全テーブルが同一パーティションキーを含む。
    * DynamoDBストリーム有効化。
    * 暗号化設定が一致。
    * TTL設定が一致。
    * グローバルセカンダリインデックスが一致。
    * 書込みキャパシティユニットでAuto Scalingまたはオンデマンドキャパシティ有効。

---

* PartiQL:AWSが公開しているSQL互換クエリ言語。2020/11/23よりDynamoDBでPartiQLによるCRUD操作が可能(一部リージョン未対応)。

#### 3-1-2 DynamoDBの可用性

* DynamoDBの可用性:自動的に3AZにレプリケートされ、単一障害点が存在しない。容量不足・スループット不足の歳には自動的にパーティション追加。
* データ書込:結果整合性がある(最終的には書込み結果と読込結果が一致する)。
    * 書込みリクエストを受信したDynamoDBはHTTP200応答を返した後に、パーティションへデータを書き込む。
    * 書込みは3AZに通常1秒以内にレプリケートされる。
    * この際に、HTTP応答とレプリケーション完了の間で最新の書込み結果が得られないことがあり得る。

---

* データ読込:強力な整合性のある読込(書込み結果と読込結果が常に同じ)をサポート。
    * NW異常発生時にはHTTP500応答が返され失敗することがある。
    * 結果整合性のある読込よりもレイテンシは高くなる。
    * グローバルセカンダリインデックスではサポートされていない。
    * 結果整合性のある読込よりもスループット容量の消費が多い。

#### 3-1-3 DynamoDBのパフォーマンス

* キャパシティモード:読込/書込操作を「ユニット」と呼ばれる単位に換算し、処理能力と利用料金が決定される。
    * 特に前者はRCU(Read Capacity Unit)、後者はWCU(Write Capacity Unit)と呼ばれる。
    * プロビジョニング済の場合の許容ユニットをキャパシティユニット、オンデマンドの場合のユニットをリクエストユニットとも呼ぶ。

---

* プロビジョニング済キャパシティモード:1秒あたりのユニット保持数を事前に決めるモード。
    * 確保された数以上のリクエスト発生時はエラー。
    * バーストキャパシティ:リクエスト急増時のために、過去300秒間で未使用のユニットを超過分に割り当てる機能。
* オンデマンドキャパシティモード:リクエスト数が予想できない場合のモード。
    * 消費ユニット数によって料金が発生する。
    * リクエストが急増しても対処可能だが、利用料金も急増する。
    * プロビジョニング済よりも新しいモード。

---

* 読込ユニット:最大4KBのItem1つに対して強力な整合性のある読込は1ユニット、結果整合性のある読込は0.5ユニット。トランザクションは2ユニット。4の倍数で切上。
    * 10KBのItemの強力な整合性ある読込なら3ユニット、結果整合性のある読込なら1.5ユニット。
    * 結果整合性で最大200回/秒の読込み:必要ユニット数100RCU。

|Itemサイズ|強い整合性|結果整合性|トランザクション|
|-|-|-|-|
|4KB以下|1ユニット|0.5ユニット|2ユニット|
|8KB以下|2ユニット|1ユニット|4ユニット|
|12KB以下|3ユニット|2ユニット|6ユニット|

---

* 書込ユニット:最大1KBのItem1つに対して1ユニット。トランザクションの場合は2ユニット。
    * 最大200回/秒の書込みが見込まれる場合、必要なユニット数は200WCU。

|Itemサイズ|通常|トランザクション|
|-|-|-|
|1KB以下|1ユニット|2ユニット|
|2KB以下|2ユニット|4ユニット|
|32KB以下|3ユニット|6ユニット|

---

* Amazon DynamoDB Auto Scaling:プロビジョニング済キャパシティモード利用時、AutoScalingを使用することでキャパシティユニットを動的に変更可能。
    * 対象はテーブルまたはグローバルセカンダリインデックス。
    * マネジメントコンソール利用時はデフォルト有効。
    * キャパシティユニット使用率の指定と変更最小値/最大値を設定する。
    * AutoScalingは数分間のワークロード変化の際に生ずる。1分間のみでは生じない。

---

* データ取得API
    * スキャン:全件走査。Attributeに対する条件指定とItem抽出が可能。ただしいったんItem全件取得するため、読込ユニット数が多い。
    * クエリ:キーをもとにデータ取得。キーのみ読込むため、ユニット消費がスキャンより少ない。こちらの方が推奨だが、テーブル設計次第では非効率となる。

---

* インデックス:検索のために付与する設定。数値型、文字列型、バイナリ型を選択可能。
* ローカルセカンダリインデックス(LSI):代替ソートキーの定義。同一パーティション内への追加インデックス。ソートキー以外をクエリ基準にしたい場合に設定。
    * テーブル作成時のみ追加可能。
    * ItemCollectionSizeLimitExceededException:パーティションキーごとのテーブルとインデックスの合計サイズ最大10GBという制限の超過。
    * Item更新時、テーブルへの書き込みと同時にLSIへの書込みが生ずる。その際に元のテーブルのWCUを消費。

---

* グローバルセカンダリインデックス(GSI):全パーティションにまたがるインデックス。パーティションキー・ソートキーとして元のデータテーブルとは別のAttributeを設定可能。
    * 既存テーブルへの追加・削除が可能。
    * Item更新時、テーブルへの書き込みと同時にGSIへの書込みが生ずる。WCUは元のテーブルとは別途設定する。一般的には元のテーブルの1.5倍が推奨。

---

* DAXの利用
    * ライトスルー方式のインメモリキャッシュ。
    * 可用性確保のため3ノード以上の利用が推奨(最大10ノードまでスケール可能)。
    * 作成時にはインスタンスタイプとノード数を指定。VPC内に構築され、DAXのエンドポイントに届くDynamoDBリクエストを処理する。
    * 読込リクエスト時、該当Itemがキャッシュに存在すれば(キャッシュヒットすれば)、その値を返す。存在しない場合、DynamoDBへリクエストを送信して、その結果で自身を更新した後、クライアントへ応答。
---

* DAXの利用(Cont.)
    * TTL設定可能(デフォルト5分)。
    * 強い整合性のある読込の場合、DAXはリクエストをそのままDynamoDBに渡す。
    * 書込みリクエスト受信時、まずはDynamoDBへリクエスト送信。書込みが成功したらDAXのキャッシュに対しても書込み、クライアントに成功レスポンスを返す。

---

* DAXが向いていないケース
    * 強い整合性のある読込:未対応。
    * 横耳でマイクロ病レベルの応答が必要ない。
    * 書込みリクエストの頻度が高い:オーバーヘッドが余分にかかる。


#### 3-1-4 DynamoDBのセキュリティ

* アクセス制御:IAMによる制御
    * テーブル:arn:aws:dynamodb:region:account-id:table/table-name
    * インデックス:arn:aws:dynamodb:region:account-id:table/table-name/index/index-name
    * ストリーム:arn:aws:dynamodb:region:account-id:table/table-name/stream/stream-label

---

* データ暗号化:デフォルトでAES-256暗号化。CMKは3タイプ使用可能。
    * AWS所有CMK:デフォルト。ユーザからは見えない。課金なし。
    * AWS管理CMK:KMS保存。キーポリシー表示・CloudTrailによる利用監査可能。ユーザ管理・アクセス許可変更不可。課金あり。
    * カスタマー管理CMK:ユーザがKMSで作成したキー。課金あり。
* VPCエンドポイント:VPCからDynamoDBへプライベート通信可能。ゲートウェイエンドポイント形式。VPCエンドポイントポリシーを設定する。

---

* ゲートウェイエンドポイントの制限
    * ネットワークACLのアウトバウンドルールでAWSプレフィックスリストIDを使用しても、エンドポイントで指定されたサービスへのアウトバウンドトラフィックは制御できない。
    * 同じリージョン内のエンドポイントのみがサポートされる。
    * IPv4トラフィックのみサポート。
    * 1つのVPCから別のVPCにエンドポイントを転送したり、1つのサービスから別のサービスにエンドポイントを転送することはできない。
    * VPCあたりに作成可能なエンドポイント数にはクォータが存在する。

#### 3-1-5 DynamoDBのコスト

* DynamoDB利用料:主に読書とデータ量、他サービスからの読込。
    * 読込・書込リクエスト
    * データストレージ
    * バックアップと復元
    * グローバルテーブルのレプリケート
    * 変更データキャプチャ
    * S3へのデータエクスポート
    * DAX
    * DynamoDBストリーム
    * データ転送

---

* 読込・書込リクエスト:オンデマンドの場合、実際に消費されたユニット数に課金。プロビジョニング済の場合、プロビジョニングしているユニットに対して1時間ごとに課金。
    * 後者の場合、WCU/RCUは100個単位でリザーブドキャパシティとして購入可能(1年または3年)。
* データストレージ:毎月最初の25GBは無料。それ以上は0.285USD/GB。

#### 3-1-6 DynamoDBのメンテナンス

* パフォーマンス改善
    * プロビジョニング済キャパシティモード利用の場合、AutoScalingの活用や、キャパシティ変更。
    * セカンダリインデックスの追加。
    * DAXの利用。
    * ItemのTTL設定。古いItemが不要な場合に使用。
    * クォータ:リージョン当たりのテーブル数256。アカウント当たりの最大読込/書込みキャパシティユニット80000。

#### 3-1-7 DynamoDBのバックアップ

* オンデマンドバックアップ:任意タイミングで実行されるバックアップ。復元はテーブル新規作成。
    * テーブル規模にかかわらずバックアップ時間は数秒。
    * 元データ削除時の残る。長期バックアップ(35日以上)はこちらを使用する。

---

* ポイントインタイムリカバリ(PITR):自動バックアップ。有効化時、過去35日間の任意時点にテーブルを復元可能。復元はテーブルを新規作成。
    * PITR有効化後に復元可能となるのは、EarliestRestorableateTimeからLatestRestorableDatetimeの任意時点。後者は通常5分前。
    * PITR無効化時、再度有効化しても復元可能なのは5分前から。
    * 元テーブル削除時、利用不可。

---

* 復元:全リージョンに可能。復元の際、復元先テーブルの設定を変更可能。
    * GSI
    * LSI
    * キャパシティモード
    * プロビジョニングされた読込・書込キャパシティ
    * 暗号化設定
* テーブル全体を復元した際、バックアップ時点の設定ではなく復元実行時の設定が適用される。

#### 3-1-8 DynamoDBのモニタリング

* CloudWatch:主要メトリクス
    * 消費読込・書込キャパシティユニット
    * スロットリングされた読込・書込キャパシティユニット
    * リクエストのレイテンシ
    * レスポンス数
    * レスポンスしたデータサイズ
    * グローバルテーブルの未レプリケーションItem数
    * TTLで削除されたItem数

---

* CloudTrail:DynamoDBへのアクセスはIAM制御なので、CloudTrailに履歴が残る。
    * ただしデフォルトでは管理系操作のみ。GetItem/PutItemなどの操作は明示的に有効化する必要がある。


#### 3-1-9 DynamoDBのトラブルシューティング

* キャパシティユニットのスロットリング:プロビジョニング済キャパシティモード使用時、設定超過のユニット消費リクエストを受けた場合、リクエストはスロットリングされてHTTP400とProvisionedThroughputExceededExceptionを返す。
    * AutoScalingやDAX導入などを検討する。
* 誤操作などによるデータ破壊:バックアップが必要。ただしテーブル名はAWSアカウント内で一意なので、元のテーブルと同名にするにはいったん元テーブルの削除が必要。
* VPCエンドポイントを利用したアクセスができない:ネットワークACLがあやしい。


### 3-2 Amazon DocumentDB
#### 3-2-1 Amazon DocumentDB(MongoDB互換)

* Amazon DocumentDB:フルマネージド型のMongoDB互換ドキュメントデータベースサービス。
* ドキュメントデータベース:JSON形式のような半構造化データを扱う。
* ユースケース:製品カタログ、ユーザプロファイル、リアルタイムのビッグデータなど。
* 基本的な特徴はAuroraと似ている。DynamoDBがサーバレスであるのと対照的。
---

* DocumentDBの構築
    * VPCおよびサブネットグループの作成。少なくともAZにサブネットが必要。
    * DocumentDBクラスタの作成
    * MongoDBからのデータ移行
        * オフライン:mongodumpツールでダンプ、mongorestoreツールでリストア。
        * オンライン:DMSを利用。
        * ハイブリッド:上記の併用。
    * DocumentDBへアクセス。RDSと同様。

---

* 移行アプローチ比較

|移行アプローチ|作業複雑度|移行速度|ダウンタイム|
|-|-|-|-|
|オフライン|低|速|大|
|オンライン|中|遅|小|
|ハイブリッド|高|中|中|

#### 3-2-2 DocumentDBの可用性

* DocumentDBクラスタの可用性:読書可能なプライマリと0～15個のリードレプリカから成る。
    * フェイルオーバー時、リードレプリカがプライマリに昇格。
    * フェイルオーバー優先度はAuroraと同じ。

* DocumentDBストレージの可用性:自動拡張。10GBごと最大64TB。
    * 3AZに6つのディスクボリュームがレプリケートされる。

#### 3-2-3 DocumentDBのパフォーマンス

* インスタンスクラス:メモリ最適化インスタンスかT3バースト可能インスタンス。
    * インスタンスクラス変更中は機能停止。
* エンドポイント:クラスター、読込、インスタンスの3種類。
    * Auroraのカスタムエンドポイントの類似物は存在しない。

#### 3-2-4 DocumentDBのセキュリティ

* セキュリティグループ:デフォルトのポート番号は27107。
* データ保管の暗号化:KMSを利用。
* データ転送の暗号化:デフォルトでTLS暗号化有効。暗号化設定はカスタムパラメータグループから。
* IAM:Auroraと同様。

---

* データベース接続のアクセス制御
    * 接続認証はユーザ名とパスワード
    * 権限設定はRBAC(ロールベースアクセスコントロール)を使用。
    * Secrets Managerによるパスワードの自動ローテーションがネイティブにサポートされている。
* ログ記録:監査ログ有効化のためには、パラメータグループで「audit_logs」の値を1にして、クラスターを手動で再起動。DBログファイルの表示やダウンロードが可能になる。

#### 3-2-5 DocumentDBのコスト
#### 3-2-6 DocumentDBのメンテナンス
#### 3-2-7 DocumentDBのバックアップ
#### 3-2-8 DocumentDBのモニタリング

* プロファイラ:クラスタで実行された操作の実行時間と詳細ログをCloudWatchLogsに記録する機能。
* DocumentDB変更ストリーム:変更イベントのログを重複なく発生順序を維持しながら他のサービスと連携できる機能。最大7日間保持。

#### 3-2-9 DocumentDBのトラブルシューティング
#### 3-2-10 Amazon AuroraとAmazon DocumentDBとの比較

* AuroraとDocumentDBの共通点
    * ストレージ可用性:3AZに6個コピー。
    * クラスター構成:1つのプライマリと最大15個のリードレプリカ。
    * フェイルオーバー優先順位:1. 指定優先度、2. サイズの大きさ、3.任意。
    * 必要なVPC設定:enableDnsHostnamesとenableDnsSupportをtrueにする。
    * データ暗号化・リソース管理権限制御・DBポートアクセス制御:KMSとTLS・IAM・SG/NACL。

---

* AuroraとDocumentDBの共通点(Cont.)
    * 課金体系:インスタンス、ストレージ、バックアップストレージ、データ転送量。
    * メンテナンスウィンドウ:リージョン毎の8時間ブロック内でランダム30分。曜日も指定しなければランダム。
    * バックアップウィンドウ:リージョン毎の8時間ブロック内でランダム30分。シングルAZ配置の場合数秒間ストレージI/O中断。マルチAZ配置の場合数分間レイテンシ上昇。
    * 自動バックアップ保持期間:1～35日。
    * ポイントタイムリカバリ:自動バックアップを使用して復旧。

---

* AuroraとDocumentDBの共通点
    * バックアップ手段:自動バックアップ(自動スナップショット・トランザクションログ)、手動スナップショット。
    * バックアップの共有・コピー:手動スナップショットはリージョン間コピー、アカウント間共有可能。自動スナップショットは手動スナップショットにコピーすれば可能。暗号化されている場合はカスタムKMSキーに共有先の権限の付与すれば可能。デフォルトKMSキーの場合はカスタムKMSキースナップショットにコピーすれば可能。
    * イベント通知:クラスター・インスタンスのイベント発生時にSNSと連携。

---

* Auroraのみの特徴
    * カスタムエンドポイント
    * IAMデータベース認証
    : Performance Insights
    * バックトラック
    * クローン機能
    * Serverlessクラスタ
    * クロスリージョン配置
    * マルチマスター配置
* DocumentDBのみの特徴:プロファイラ

---

* その他差異

|機能|Aurora|DocumentDB|
|-|-|-|
|DBの種類|RDB|NoSQL|
|サポートDB|MySQL/PostgreSQL|MongoDB|
|ストレージ拡張|10GBごとに最大128TB|10GBごとに最大64TB|
|ポート|3306/5432|27107|
|監査ログ連携|server_audit_logging|audit_logs|
|ストリーム|DBアクティビティストリーム|変更ストリーム|

### 3-3 NoSQLデータベースサービスまとめ


## 4章 その他のデータベースサービス
### 4-1 Amazon ElastiCache
#### 4-1-1 Amazon ElastiCache

* Amazon ElastiCache:フルマネージド型のインメモリデータストア。MemcachedおよびRedis互換。
* Amazon ElastiCache for Memcached:シンプルなキーバリュー型インメモリキャッシュシステム。
    * 文字列型のみ利用可能。
    * 単純にリクエストを受けるノードをスケールアウト/インすることで負荷分散。スケールアップしたクラスター再構築も容易。
    * アクセス頻度の高いデータ向け。データの永続化は不可能。
    * マルチスレッド。ノードのCPUコア数が多いほど性能アップ。

---

* Amazon ElastiCache for Redis:キーバリュー型インメモリデータベース。
    * リスト型、データ集合、ハッシュ型などに対応。
    * ノードのマスタスレーブ型レプリケーション、クラスター構成対応など機能が豊富。
    * マルチAZ構成や自動フェールオーバー可能。
    * スナップショット機能をもつ。
    * トランザクション機能をもつ。
    * Pub/Subメッセージング機能、Luaスクリプト実行機能、地理空間データ処理機能などももつ。

#### 4-1-2 ElastiCacheの可用性

* ElastiCache for Memcachedのクラスター構成
    * インスタンスノードを指定数含むクラスターとして動作。ノード数はデフォルトで1～20。
    * ノード障害は自動検出・置換される。
    * データは各ノードに分散格納。
    * 接続先ノード(エンドポイント)のリストを、クライアント側で実装する必要がある。自動ノード振り分け機能は存在しない。
    * 自動検出クライアントは用意されている(Java、PHP、.NET)。「Configエンドポイント」にアクセスすることで、稼働中エンドポイントのリストを取得する。

---

* ElastiCache for Redisのクラスター構成
    * 複数ノードから成る「シャード(ノードグループ)」によって構成される。
    * シャード内では、一つのノードが読込書込用プライマリノードとなり、ほかはリードレプリカ(0～5個)となる。
    * クラスターモード:有効化時、複数シャードを構成、各シャー度にデータを分散。無効化時は単一シャード構成。
    * 5.0.6以降のバージョンでは、ノード数最大500。レプリカ5個のシャードは最大83($6\times 83 = 498$)。
    * エンドポイントへのアクセスによって読書可能。

---

* グローバルデータストア:ElastiCache for Redisの機能。クラスターのレプリカを別リージョンに作成できる。
    * プライマリは読書、セカンダリは読込専用。
    * セカンダリをプライマリに昇格させることが可能。
    
#### 4-1-3 ElastiCacheのパフォーマンス

* ElastiCache for Memcachedのスケーリング
    * 各々のノードが読書エンドポイント。そのためシンプルにノードの追加・削除によって水平スケーリングが可能。
    * 1クラスター内ノードはデフォルト20個、1リージョンで最大100個。それ以上は上限緩和申請が必要。
    * スケールアップの際は、新しいノードタイプで新しいクラスターを作成する。データの永続化ができないため。

---

* ElastiCache for Redisのスケーリング
    * クラスターモード無効:スケールアップ・ダウン両方可能。即時または次回のメンテナンスウィンドウ。後からレプリカ追加・削除可能。
    * クラスターモード有効
        * スケールアップは無効の場合と同じ。
        * スケールアウト(シャードの追加)はmemcachedのノード追加と同様。リシャーディング(データ量の偏り平均化のためのデータ再分散)も併せて発生する。
        * いずれもダウンタイムなし(3.2.10以降)。
        * シャード内ノード数は変更不可能。

#### 4-1-4 ElastiCacheのセキュリティ

* 3.2.6/4.0.10以降のElastiCache for Redisでは、転送時データ暗号化・保管データ暗号化が可能。
    * 転送時暗号化有効時、TLS暗号化。
    * Redis AUTH機能を利用したクライアント認証も設定可能。
    * バージョン6.x系ではRBAC(ロールベースアクセスコントロール)も可能。
    * 保管時暗号化有効時、同期・バックアップ・スワップオペレーション中ディスク・S3バックアップが暗号化される。キーはデフォルトかユーザ管理CMK。
    * 暗号化設定はクラスタ作成時にのみ有効化可能。

---

* VPCにおけるアクセス制御
    * ElastiCacheクラスターはVPC内に作成される。
    * クラスターノードにはサブネットCIDR範囲のプライベートIPアドレスが割り振られる。
    * アクセス制御はSG/NACLによって可能。

#### 4-1-5 ElastiCacheのコスト

* ノードに対するインスタンスサイズとデータ転送量、スナップショットが課金対象。
* リザーブドノードが用意されている。

#### 4-1-6 ElastiCacheのメンテナンス

* ノード、ホストOSのアップグレード:ElastiCacheのパッチ適用とアップグレードはシームレス。ホストOSの更新はノードの再起動が必要(メンテナンスウィンドウで行う。
* パラメータグループ:クラスタ単位で紐づける。デフォルトパラメータグループの内容は変更不可。

#### 4-1-7 ElastiCacheのバックアップ

* ElastiCache for Redisのバックアップと復元
    * クラスタ全体のバックアップをAWS管理S3に保管。
    * Redisはデータ永続化の手法として、RDBファイルと呼ばれる形式でデータをディスクに保存。このファイルを起動時に読込むことでデータを復元する。
    * バックアップデータをRDBファイルとしてS3にエクスポート可能。
    * 自動バックアップ:日次取得。
    * 手動バックアップ:24時間で、ノードあたり20個まで。
    * クラスター削除時、最終バックアップ取得可能。

---

* ElastiCache for RedisのAOF(Append Only Files)
    * データ永続化の機能。キャッシュデータを変更する全コマンドをファイルに書き込み。障害時にこのファイルからデータを復旧する。
    * デフォルト無効。
    * 非推奨。代わりにレプリケーショングループでマルチAZを有効化したクラスター構成が推奨される。

#### 4-1-8 ElastiCacheのモニタリング

* ホストレベルのメトリクス:CPU利用率、メモリの空き容量、スワップの使用量、ネットワーク転送量など。
* Memcacheのメトリクス:キャッシュ項目の格納に使用したバイト数、ネットワークから読込まれたバイト数、キャッシュへの接続数など。
* Redisのメトリクス:キャッシュヒット/ミス数、クライアントの接続数など。
* ElastiCacheイベント:SNSトピックへ連携。

#### 4-1-9 ElastiCacheのトラブルシューティング

* ElastiCacheに接続できない:SG/NACL。
* Redisクラスターへノードを追加できない:IPアドレス不足。

## 4-2 Amazon Neptune
#### 4-2-1 Amazon Neptune

* Amazon Neptune:フルマネージド型のグラフデータベースを提供するサービス。Property Graph(クエリ言語:Apache TinkerPop Gremlin)とW3CのRDF(クエリ言語:SPARQL)をサポート。
* エンティティをノード、リレーションシップをエッジと呼ぶ。ノード/エッジの名称をラベル、ノード/エッジの属性やメタデータをプロパティと呼ぶ。
* クラスタ構成は、基本的にはAuroraと似ている。

#### 4-2-9 Neptuneのトラブルシューティング

* バルクローダのロードが遅い
    * インスタンスクラスを大きくする。
    * parallelismパラメータにOVERSUBSCRIBE並列処理パラメータを指定する。
    * queueRequestパラメータをTRUEに設定する。
* バルクローダのエラー対処
    * バルクローダAPIで個々のロードを各ジョブのステータスを確認しながら実行し、失敗したジョブを特定する。
    * failOnErrorパラメータで、エラー発生時にバルクロード操作を続行するかを指定する。
    * modeパラメータでロードエラー時の再処理を指定する。

#### 4-2-10 Amazon AuroraとAmazon Neptuneとの比較

* AuroraとNeptuneの共通点
    * ストレージ可用性:3AZに6個コピー。
    * クラスター構成:1つのプライマリと最大15個のリードレプリカ。
    * フェイルオーバー優先順位:1. 指定優先度、2. サイズの大きさ、3.任意。
    * エンドポイントの種類:クラスターエンドポイント、リーダーエンドポイント、インスタンスエンドポイント、インスタンスエンドポイント、カスタムエンドポイント。
    * 必要なVPC設定:enableDnsHostnamesとenableDnsSupportをtrueにする。

---

* AuroraとNeptuneの共通点(Cont.)
    * リソース管理権限制御・DBポートアクセス制御:KMSとTLS・IAM・SG/NACL。
    * 課金体系:インスタンス、ストレージ、バックアップストレージ、データ転送量。
    * メンテナンスウィンドウ:リージョン毎の8時間ブロック内でランダム30分。曜日も指定しなければランダム。
    * バックアップウィンドウ:リージョン毎の8時間ブロック内でランダム30分。シングルAZ配置の場合数秒間ストレージI/O中断。マルチAZ配置の場合数分間レイテンシ上昇。
    * 自動バックアップ保持期間:1～35日。

---

* AuroraとNeptuneの共通点(Cont.)
    * ポイントタイムリカバリ:自動バックアップを使用して復旧。
    * バックアップ手段:自動バックアップ(自動スナップショット・トランザクションログ)、手動スナップショット。
    * バックアップの共有・コピー:手動スナップショットはリージョン間コピー、アカウント間共有可能。自動スナップショットは手動スナップショットにコピーすれば可能。暗号化されている場合はカスタムKMSキーに共有先の権限の付与すれば可能。デフォルトKMSキーの場合はカスタムKMSキースナップショットにコピーすれば可能。
    * イベント通知:クラスター・インスタンスのイベント発生時にSNSと連携。

---

* Auroraのみの特徴
    * Performance Insights
    * バックトラック
    * クローン機能
    * Serverlessクラスタ
    * クロスリージョン配置
    * マルチマスター配置
---

* その他差異

|機能|Aurora|Neptune|
|-|-|-|
|DBの種類|RDB|GraphDB|
|サポートDB|MySQL/PostgreSQL|Gremlin/SPARQL|
|ストレージ拡張|10GBごとに最大128TB|10GBごとに最大64TB|
|ポート|3306/5432|8182|
|データ転送暗号化|TLSデフォルト有効|TLS強制|


---

* その他差異(Cont.)

|機能|Aurora|Neptune|
|-|-|-|
|DB接続権限制御|ユーザ名・パスワード/IAMDB認証|IAMDB認証|
|監査ログ連携|server_audit_logging|neptune_enable_audit_log|
|ストリーム|DBアクティビティストリーム|Neptuneストリーム|


### Amazon QLDB
#### 4-3-1 Amazon Quantum Ledger Database(QLDB)

* Amazon Quantum Ledger Database(QLDB):変更履歴を不変で完全に検証可能な状態で長期保持できるサーバレスなフルマネージド型台帳データベース。
* 暗号ハッシュ技術を用いて、データのハッシュを連結及び連鎖させることで、ジャーナルと呼ばれるトランザクションログを改ざん不可能にする。
* ブロックチェーンに似て非なるもの。一般的な分散型ブロックチェーン台帳はネットワーク内メンバでトランザクションの妥当性検証。QLDBは中央集権型で分散型よりも2～3倍高速。
* ユースケース:金融取引、サプライチェーンシステム、保険金請求、人事管理や給与支払い、などの記録と履歴管理。

---

* ジャーナル:トランザクションログに似た不変の追加専用データ構造。更新や削除の書込みトランザクションはすべて最初にジャーナルにコミットされる。
* QLDBでは、このジャーナルをクエリ可能なテーブルにして、台帳データの現在の状態を確認可能。
* データは、Amazonオリジナルの「Amazon lonドキュメント」のテーブルから成る。SQL互換の「PartiQL」を使用してクエリ。
* QLDBはトランザクションで1つ以上のチェーンブロックをジャーナルに書き込み。各ブロックにはPartiQLと挿入・更新・削除するドキュメントリビジョンを表すエントリオブジェクトが含まれる。この各ブロックのハッシュ値を後続のブロックにチェーンしていくことでデータの整合性を保証する。

---

* QLDBのストレージ
    * ジャーナルストレージ:全データの不変で完全に検証可能な状態の変更履歴を保持するジャーナルのディスク領域。
    * インデックス付きストレージ:ハイパフォーマンスクエリ用に最適化された台帳データで構成され、台帳のテーブル、インデックス、インデックス付き履歴を保持するディスク領域。
* データの検証
    1. ダイジェスト取得:Amazon lon形式コンテンツが返却される。
    2. データ検証:ダイジェストと照合することでドキュメントリビジョンを検証する。

#### 4-3-2 QLDBの可用性
#### 4-3-3 QLDBのパフォーマンス

* 同時実行モデルにオプティミスティック同時実行制御を採用。ハイパフォーマンスなOLTP対応。

#### 4-3-4 QLDBのセキュリティ

* PrivateLinkと統合されているため、VPCへエンドポイント接続可能。
* 接続および操作はIAM管理。

#### 4-3-5 QLDBのコスト
#### 4-3-6 QLDBのメンテナンス

* サーバレスのため、インスタンスレベルのメンテナンスは不要。

#### 4-3-7 QLDBのバックアップ

* バックアップはサポートしていない。
* 日時範囲を選択して、S3へジャーナルブロックをエクスポート可能。

#### 4-3-8 QLDBのモニタリング

* QLDBストリーム:すべてのドキュメントリビジョンの変更をKinesisに連携。
* ユースケース:Elasticsearch Serviceにストリーミングして、全文検索や視覚化する。

#### 4-3-9 QLDBのトラブルシューティング

### 4-4 Amazon Elasticsearch Service

* Amazon Elasticsearch Service(ES):Elsaticsearchのデプロイ・運用サービス。
* ストリーミングそりアプリから送られてくるJSOデータを登録し、クラスタあたり最大3PBまで保存。
* 資格化ダッシュボード「Kibana」とともに使用することができる。
* ユースケース:リアルタイムモニタリング、ログ管理、全文検索、ログ分析、クリックストリーム分析など。データの分析と検索。
* DB系サービスのストリームデータを、Kinesisなどを使用してESに連携する。

---

* データ連携例
* プッシュモデル:AuroraやQLDBからKinesis Data StreamsにプッシュされたストリームをKinesis Data Firehose、Lambdaなどで処理してESに連携する。
* プルモデル:DynamoDB、DocumentDBやNeptuneに保存されたストリームをLambdaからポーリングして直接またはKinesis Data Firehoseなどを経由してESに連携する。

### 4-5 その他のデータベースサービスまとめ





## 6章 監視、トラブルシューティング、セキュリティ

### 6-1 AWS CloudTrail
### 6-2 Amazon CloudWatch
### 6-3 AWS Identity and Access Management
### 6-4 AWS Key Management Service
### 6-5 AWS Secrets ManagerとAWS　Systems Managerパラメータストア
### 6-6 監視、トラブルシューティング、セキュリティまとめ

## 7章 AWS Well-Architected


## 5章 展開および移行
### 5-1 AWS CloudFormation

* AWS Cloudformation(CFn):JSON/YAML形式でAWSリソースをテンプレートファイル化し、構築を自動化する機能。
* スタック:テンプレートファイルのデプロイによって作成されるAWSリソース。
* 変更セット:スタック更新前に変更されるリソース情報を事前に確認できる機能。
* 認証情報の管理:Secrets Manager/Systems Managerパラメータストアを使用。

---

* DeletionPolicy:リソース削除動作を指定する属性。
    * Delete:スタック削除時にリソース削除。
    * Retain:スタック削除時にリソース保持。
    * Snapshot:スタック削除時にリソース削除・スナップショット取得。
* スタックの削除保護:有効化で削除不可にする。
* スタックポリシー:リソースベースのポリシー。

* ドリフト検出:テンプレートと実環境の差分検出。
* StackSets:テンプレートを用いて複数環境にデプロイする機能。複数アカウント・複数リージョンにデプロイしたい場合に使用。

### 5-2 移行(マイグレーション)
### 5-2-1 データベース移行の流れ

* 移行パターン例
    * 一括移行:エクスポート・転送・インポートを一度飲み実行。移行中のデータ更新不可(サービスダウン)。
    * 二段階移行:エクスポート・インポートを2回実行。1回目の移行中の変更点が2回目で繁栄可能。サービスダウンは2回目の更新分だけで済む。
    * リアルタイム同期:一度エクスポート・インポートを実行後、リアルタイムに更新内容を同期する。サービスダウンはほぼない。
* 移行元/先DBエンジンが異なる場合はDMSなどを使用する。エンジンが同じ場合を見ていく。

### 5-2-2 Amazon Auroraへの移行


* Auroraリードレプリカを使用した移行
    * 通常のRDSインスタンスからAuroraのリードレプリカを作成して移行。MySQL/PostgreSQL両方とも可能。
    1. 移行元DBインスタンスからAuroraリードレプリカを作成することで、移行元RDSのスナップショットが作成される。
    2. スナップショットからAuroraリードレプリカにデータがコピーされる。
    3. コピー後、継続的レプリケーションが実行される。
    4. クライアント準備完了後、リードレプリカをプライマリに昇格させる。

---

* スナップショットを使用した移行
    * RDSインスタンスのスナップショットからAuroraDBクラスタを復元。
    * DBの一時的利用停止が許容される場合、簡単。MySQL/PostgreQL両方可能。
* mysqldumpを使用したデータ移行
    * MySQL標準バックアップツールであるmysqldumpコマンドを指定してAuroraクラスターへデータインポートを行う。

---

* S3上のバックアップファイルから移行
    * MySQLのバックアップツールであるPercona XtraBackupツールを使用する。バックアップファイルをS3バケット上に格納し、そのファイルからAuroraクラスタを新規作成する。mysqldumpより高速。
* S3上のテキストファイルから移行
    * CSVファイルなどを用意して、auroraクラスター上のDBへインポートする。他のDBエンジンからも可能な場合がある。

### 5-2-3 AWS Schema Conversion ToolとAWS Database Migration Service

* DB移行に際しての関心事項
    * 送信元・送信先のDBの種類
    * 移行期間
    * 許容可能なダウンタイム

---

* AWS Schema Conversion Tool(AWS SCT):ローカルマシンなどにインストールして、送信元・送信先DB間でDBスキーマ変換を行うサービス。
    * リレーショナルOLTPスキーマとデータウェアハウススキーマの返還をサポート。
    * 移行前にDB間で自動的なスキーマ変換の可否などの移行評価レポートを作成する機能がある。
* AWSSCTデータ抽出エージェント:オンプレのデータウェアハウスからデータを抽出してS3にアップロードし、Redshiftに移行する。

---

* AWS Database Migration Service(AWS DMS):
    * RDB、DWH、NoSQLDBなどを移行するサービス。
    * オンプレからAWS、AWSからオンプレ、AWSからAWSの同種間・異種間移行をサポート。
    * 移行後に正確な移行が完了したか確認する検証機能がある。
* DMSのコンポーネント
    * ソース/ターゲットデータベース:送信元/先DB。
    * ソース/ターゲットエンドポイント:ソース/ターゲットデータベースに接続するためのエンドポイント。
    * レプリケーションインスタンス:レプリケーションタスクを実行するEC2インスタンス。

---

* 移行パターン
    * ソースとターゲットが同じVPC内に存在する:DMSは同じVPC内にレプリケーションインスタンスを配置してタスクを実行する。
    * ソースとターゲットが異なるVPC内に存在する:VPCピアリングなどで接続。
    * ソースがオンプレ、ターゲットがVPCに存在:DX、VPN、インターネット(SSL/TLS)で接続。

---

* フルロードとCDC(変更データキャプチャ):継続的なレプリケーションタスクを使用して、最小限の差分でダウンタイムを最小化可能。
     * フルロード+ CDC:ソースデータを初回にすべて移行(フルロード)し、差分を継続的に移行(CDC)する。
     * CDC:変更データの差分を継続的に移行(CDC)。
* ラージバイナリオブジェクト(LOB)の移行
    * 完全LOBモード:全LOBを移行するが、パフォーマンス低下の可能性がある。
    * 制限付きLOBモード:最大LOBサイズを指定。
    * インラインLOBモード:完全/制限付きの利点の組み合わせ。フルロード時のみ使用可能。

---

* AWSSCTとAWSDMSを組み合わせた移行パターン:ソース・ターゲット間の接続の回線速度が移行期間の要件を満たしていると想定
1. SCTを使用してスキーマ変換可否を移行評価レポートで確認。
2. SCTを使用してソースのスキーマを変換してターゲットに適用。
3. DMSを使用してフルロードで全データ移行。
4. DMSでデータ検証が有効な場合は、フルロード後にデータ検証が開始され以降CDC中も実行される。
5. DMSを使用してCDCでソースからターゲットに変更データの差分を継続的に移行。
6. ソースからターゲットにカットオーバー。

---

* AWSSCT、AWSDMS、AWS Snowball Edgeを組み合わせた移行パターン:接続している回線速度では1週間以上かかると想定
1. Snowball Edgeをリクエストして数日後に到着。
2. SCTを使用してスキーマ変換可否を移行評価レポートで確認。
3. SCTを使用してソースのスキーマを変換してターゲットに適用。
4. SCTでローカルタスクとDMSタスクを管理し、Snowball EdgeクライアントとDMSエージェントを実行するローカルマシンのローカルタスクでソースからSnowball Edgeデバイスにデータを転送して返送。

---

5. 1週間程度でAWSに届いたSnowball EdgeデバイスからS3にデータがロードされる。
6. DMSタスクがフルロードでS3からターゲットに全データを移行。
7. DMSタスクがCDCでソースからターゲットに変更データの差分を継続的に移行。
8. ソースからターゲットにカットオーバー。

### 5-3 展開および移行まとめ


## 6章 監視、トラブルシューティング、セキュリティ

### 6-1 AWS CloudTrail
### 6-2 Amazon CloudWatch
### 6-3 AWS Identity and Access Management
### 6-4 AWS Key Management Service
### 6-5 AWS Secrets ManagerとAWS　Systems Managerパラメータストア
### 6-6 監視、トラブルシューティング、セキュリティまとめ

## 7章 AWS Well-Architected